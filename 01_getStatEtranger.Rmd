---
title: "Dataviz étranger en Suisse"
author: "Duc-Quang Nguyen"
date: "21 January 2016"
output: html_document
---


### Data 

##### Link 
* [Population résidante permanente et non permanente selon les niveaux géographiques institutionnels, le sexe, la nationalité et l'âge](https://www.pxweb.bfs.admin.ch/Selection.aspx?px_language=fr&px_db=px-x-0103010000_101&px_tableid=px-x-0103010000_101\px-x-0103010000_101.px&px_type=PX)

#### Select 
 * 2014
 * Suisse
 * Type de population -> tout
 * sexe - Total
 * Autorisation de résidence -> tout sauf Autorisation de résidence - total (10)
 * Classe d'âge total
 * Nationalité -> tout sauf Nationalité - total (201)

40020 cellules sélectionées and Saved as : px-x-0103010000_101.csv

### Open and clean up: remove non-needed columns

### Open with Google Refine, set the encoding to latin and export as CSV: px-x-0103010000_101_cleaned_refined.csv

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(swiMap)
library(countrycode)

data.read <- read_csv("data/px-x-0103010000_101_cleaned_refined.csv")

# wide to long transform
data <- data.read %>% gather(country, value, 3:ncol(data.read))

# sum the values by the pop permanente / non-permanente
data %>% group_by(`Autorisation de résidence`, country) %>% 
  summarise(tot = sum(value, na.rm = T)) %>% ungroup() -> data
data$country <- as.character(data$country)

## replace unknow origin by "Inconu"
data <- data %>% mutate(country = replace(country,
  country %in% c('Apatride', "Non attribuable selon frontières actuelles", "Sans indication"),
  "inconnu"))

## find the top country
sum <- data %>% group_by(country) %>% summarise(value = sum(tot, na.rm = T)) %>% ungroup() %>% arrange(desc(value))
sum[sum$value < 400,'country'] %>% unlist(use.name = F) -> countries.sub

# replace unfrequent country by "autres"
data <- data %>% mutate(country = replace(country,
  country %in% countries.sub,
  "autres"))
data %>% group_by(`Autorisation de résidence`, country) %>% 
  summarise(value = sum(tot, na.rm = T)) %>% ungroup() -> data

## match country names to translation
idx <- match(unique(data$country), countryTranslations$FR)
unique(data$country)[which(is.na(idx))]


## Hack to rename unmatched countries
countries_rename <- 
  c("Arabie saoudite"       , "autres"                 , "Azerbaïdjan"            , "Bosnie et Herzégovine"  ,
    "Congo (Brazzaville)"     , "Congo (Kinshasa)"       , "Corée (Sud)"            , "Côte d'Ivoire"          ,
    "Danemark"                , "Egypte"                 , "Equateur"               , "Erythrée"               ,
    "Etats-Unis"              , "Ethiopie"               , "Haïti"                  , "inconnu"                ,
    "Irak"                    , "Iran"                   , "Kosovo"                 , "Macédoine"              ,
    "Moldova"                 , "République dominicaine" , "République tchèque"     , "Russie"                 ,
    "Taïwan (Taipei chinois)" , "Vietnam" 
) 

names(countries_rename) <- 
  c('Arabie Saoudite', 'autres', 'Azerbaédjan', 'Bosnie-Herzégovine',
    'Congo', 'La République démocratique du Congo', 'République de Corée', "Côte d'ivoire",
    'Denmark', "Égypte", "Équateur", "Érythrée",
    "États-Unis", "Éthiopie", "Haiti", "inconnu",
    "Iraq", "République Islamique d'Iran", "Kosovo", "Macédoine",
    "Moldavie", "Dominicaine république", "République tchéque", "Fédération de Russie",
    "Taïwan, Province de Chine", "Viet Nam"
  )

# replace names
data <- as.data.frame(data)
idx <- which(data$country %in% countries_rename)
data[idx,'country'] <- names(countries_rename)[
  match(data[idx,'country'] %>% unlist(use.names = F), countries_rename)]


countries <- data.frame(country = unique(data$country))
countries$iso2 <- countryTranslations[match(countries$country,countryTranslations$FR), 'iso2']
countries$continent <- countrycode(countries$iso2, "iso2c", "continent")


### Shape the data for sunburst







```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
